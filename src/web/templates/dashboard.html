{% extends "base.html" %}

{% block title %}Dashboard - Trading Bot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Dashboard</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Status do Bot</h5>
                <p class="card-text" id="bot-status">Carregando...</p>
                <button class="btn btn-success" id="start-bot">Iniciar</button>
                <button class="btn btn-danger" id="stop-bot">Parar</button>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Saldo</h5>
                <p class="card-text" id="balance">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Posições Ativas</h5>
                <p class="card-text" id="active-positions">0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">P&L Diário</h5>
                <p class="card-text" id="daily-pnl">$0.00</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Log de Atividades</h5>
                <div id="activity-log" style="height: 300px; overflow-y: scroll;">
                    <!-- Logs serão inseridos aqui -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Configurar Socket.IO com reconexão
    const socket = io({
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        timeout: 20000,
        autoConnect: true,
        forceNew: false,
        transports: ['websocket', 'polling']
    });

    // Variável para controlar tentativas de reconexão
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;

    // Eventos de conexão
    socket.io.on("reconnect_attempt", (attempt) => {
        reconnectAttempts = attempt;
        addLogMessage(`Tentativa de reconexão ${attempt} de ${maxReconnectAttempts}`);
    });
    socket.on('connect', () => {
        console.log('Conectado ao servidor');
        addLogMessage('Conexão WebSocket estabelecida');
    });

    socket.on('disconnect', () => {
        console.log('Desconectado do servidor');
        addLogMessage('Conexão WebSocket perdida. Tentando reconectar...');
    });

    socket.on('error', (error) => {
        console.error('Erro Socket.IO:', error);
        addLogMessage('Erro na conexão WebSocket: ' + error.message);
    });

    socket.on('connect_error', (error) => {
        console.error('Erro de conexão:', error);
        addLogMessage('Erro ao conectar com o servidor');
    });

    // Função auxiliar para adicionar mensagens ao log
    function addLogMessage(message) {
        const logDiv = document.getElementById('activity-log');
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.insertBefore(p, logDiv.firstChild);
    }

    // Ouvir atualizações de posições via WebSocket
    let lastUpdateTime = 0;
    socket.on('update_positions', function(data) {
        // Evitar atualizações muito frequentes
        const now = Date.now();
        if (now - lastUpdateTime < 500) return; // Limitar a 2 atualizações por segundo
        lastUpdateTime = now;
        document.getElementById('active-positions').textContent = data.active_positions;
        document.getElementById('daily-pnl').textContent = `$${data.daily_pnl.toFixed(2)}`;
    });

    // Atualizar status periodicamente
    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('bot-status').textContent = data.running ? 'Ativo' : 'Inativo';
                document.getElementById('balance').textContent = `$${data.balance.toFixed(2)}`;
                document.getElementById('active-positions').textContent = data.positions;
                document.getElementById('daily-pnl').textContent = `$${data.daily_pnl ? data.daily_pnl.toFixed(2) : '0.00'}`;
                // Atualizar logs
                if (data.errors) {
                    const logDiv = document.getElementById('activity-log');
                    logDiv.innerHTML = '';
                    data.errors.forEach(function(log) {
                        const p = document.createElement('p');
                        p.textContent = log;
                        logDiv.appendChild(p);
                    });
                }
            });
    }

    // Botões de controle
    document.getElementById('start-bot').addEventListener('click', function() {
        fetch('/api/start-bot', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Erro: ' + data.error);
                } else {
                    alert('Bot iniciado com sucesso!');
                    updateStatus();
                }
            });
    });

    document.getElementById('stop-bot').addEventListener('click', function() {
        fetch('/api/stop-bot', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Erro: ' + data.error);
                } else {
                    alert('Bot parado com sucesso!');
                    updateStatus();
                }
            });
    });

    // Atualizar status a cada 5 segundos
    setInterval(updateStatus, 5000);
    updateStatus(); // Primeira atualização
</script>
{% endblock %}